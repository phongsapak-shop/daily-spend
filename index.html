<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expense Tracker</title>

<!-- Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: linear-gradient(135deg,#667eea,#764ba2);
  min-height: 100vh;
}

.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}

.card {
  background: #fff;
  border-radius: 20px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,.15);
}

h2 { margin-top: 0; }

input, select, button {
  width: 100%;
  padding: 12px;
  margin: 6px 0 12px;
  border-radius: 12px;
  border: 1px solid #ddd;
  font-size: 16px;
}

button {
  background: linear-gradient(135deg,#667eea,#764ba2);
  color: #fff;
  border: none;
  font-weight: bold;
  cursor: pointer;
}

button:active { transform: scale(.97); }

.clear-btn {
  margin-top: 12px;
  background: linear-gradient(135deg,#ff416c,#ff4b2b);
  color: #fff;
}

img {
  width: 100%;
  border-radius: 12px;
  display: none;
  margin-bottom: 12px;
}

.budget-display {
  text-align: center;
  font-size: 20px;
  font-weight: bold;
}

.green { color:#2ecc71 }
.yellow { color:#f1c40f }
.redText { color:#e74c3c }

.history-item {
  border-bottom: 1px solid #eee;
  padding: 8px 0;
  font-size: 14px;
}
</style>
</head>

<body>
<div class="container">

<!-- ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö -->
<div class="card">
  <h2>‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h2>
  <input type="number" id="budgetAmount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">
  <select id="budgetType">
    <option value="‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
    <option value="‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
    <option value="‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
  </select>
  <button onclick="saveBudget()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏ö</button>
</div>

<!-- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ -->
<div class="card">
  <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h2>
  <input id="expenseName" placeholder="‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∞‡πÑ‡∏£">
  <input type="number" id="expenseAmount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">

  <select id="expenseCategory">
    <option>‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
    <option>‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</option>
    <option>‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ</option>
    <option>‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
  </select>

  <input type="file" accept="image/*" id="photoInput">
  <img id="preview">

  <button type="button" onclick="scanSlip()">üì∏ ‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏•‡∏¥‡∏õ (OCR)</button>
  <button onclick="saveExpense()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>

<!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
<div class="card">
  <h2>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h2>
  <div id="history"></div>

  <button onclick="exportExcel()">üì§ Export Excel</button>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á (‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô) -->
  <button class="clear-btn" onclick="clearHistory()">
    üóë ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  </button>
</div>

<!-- ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î) -->
<div class="card">
  <div id="budgetDisplay" class="budget-display">
    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö
  </div>
</div>

</div>

<script>
let budget = JSON.parse(localStorage.getItem('budget'));
let expenses = JSON.parse(localStorage.getItem('expenses')) || [];

const budgetDisplay = document.getElementById('budgetDisplay');
const historyDiv = document.getElementById('history');

/* ===== ‡∏á‡∏ö ===== */
function saveBudget() {
  const amount = Number(budgetAmount.value);
  const type = budgetType.value;
  if (!amount) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì');

  budget = { amount, type };
  localStorage.setItem('budget', JSON.stringify(budget));
  updateDisplay();
}

/* ===== ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ===== */
function saveExpense() {
  const name = expenseName.value;
  const amount = Number(expenseAmount.value);
  const cat = expenseCategory.value;

  if (!name || !amount) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');

  expenses.push({
    name, amount, cat,
    time: new Date().toLocaleString()
  });

  localStorage.setItem('expenses', JSON.stringify(expenses));

  expenseName.value = '';
  expenseAmount.value = '';
  preview.style.display = 'none';

  renderHistory();
  updateDisplay();
}

/* ===== ‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏ö ===== */
function updateDisplay() {
  if (!budget) {
    budgetDisplay.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö';
    return;
  }

  const spent = expenses.reduce((s,e)=>s+e.amount,0);
  const remain = budget.amount - spent;
  const ratio = remain / budget.amount;

  let cls = 'green';
  if (ratio < 0.3) cls = 'redText';
  else if (ratio < 0.6) cls = 'yellow';

  budgetDisplay.className = 'budget-display ' + cls;
  budgetDisplay.textContent =
    `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remain} ‡∏ö‡∏≤‡∏ó (${budget.type})`;
}

/* ===== ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ===== */
function renderHistory() {
  historyDiv.innerHTML = '';
  expenses.slice().reverse().forEach(e=>{
    historyDiv.innerHTML += `
      <div class="history-item">
        <b>${e.name}</b> - ${e.amount} ‡∏ö‡∏≤‡∏ó<br>
        ${e.cat} | ${e.time}
      </div>`;
  });
}

/* ===== ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ===== */
function clearHistory() {
  if (!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  expenses = [];
  localStorage.removeItem('expenses');
  renderHistory();
  updateDisplay();
}

/* ===== Export Excel ===== */
function exportExcel() {
  if (expenses.length === 0) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');

  const ws = XLSX.utils.json_to_sheet(expenses);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
  XLSX.writeFile(wb, 'expenses.xlsx');
}

/* ===== OCR ===== */
async function scanSlip() {
  if (!preview.src) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô');

  alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏•‡∏¥‡∏õ...');
  const res = await Tesseract.recognize(preview.src,'eng+tha');
  const nums = res.data.text.match(/\d+(\.\d{1,2})?/g);
  if (!nums) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô');

  expenseAmount.value = Math.max(...nums.map(Number));
}

/* ===== ‡∏£‡∏π‡∏õ ===== */
photoInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  const r = new FileReader();
  r.onload = () => {
    preview.src = r.result;
    preview.style.display = 'block';
  };
  r.readAsDataURL(file);
};

renderHistory();
updateDisplay();
</script>
</body>
</html>
